<!-- views/admin/pages/tracklist.ejs -->

<!DOCTYPE html>
<html lang="en">

<head>
  <% include ../partials/head %>
  <!-- <script>var track_id = window.location.search.split("=")[1];</script> -->

</head>

<body>
  <header>
    <% include ../partials/header %>
  </header>

  <div id='search-track' class="container">
    <div class="row">
      <div class="offset-md-1 col-md-10 login-form-1">
        <h3>Bot Dashboard</h3>
        <p id="errorMsg" style="
        float: left;
        font-size: 21px;
        margin: 5px 5px 5px 5px;
        color: #b30a0ab0;
        padding: 1px 10px;"></p>
        <button id="onClickAddNewTrack" class="btn btn-info" style="
          float: right;
          font-size: 13px;
          margin: 5px 5px 5px 5px;">
          <i class="fa fa-arrow-circle-left"></i> &nbsp Dashboard
          <!-- <i class="fa fa-arrow-left"></i> &nbsp Dashboard -->

        </button>
        <div id="list-music-track" class="form-control" style="min-height: 45px;"></div>
        <div id="track-details" class="form-control" style="min-height: 230px; max-height: 1200px;">
          <div class="alert alert-lite" role="alert" style="text-align: center; ">Bot Status </div>




          <div id="botstatus" class="alert alert-success" role="alert" style="text-align: center;"><span></span><span onclick="$('#botstatusDetails ').toggle(); $('#systemResponse ').toggle(); $('#system ').toggle(); return false;" class="alert-link" style="text-decoration: underline; cursor: pointer;">Click here</span> </div>
          <div id="botstatusDetails" class="alert alert-lite" style="display: none" role="alert" > status: </div>
          <div id="system" class="form-control" style="height: 108px; display: none; width: 88%; border: none; margin: auto;"> 
            <button onclick="systemTask('getInfo')" class="btn btn-info" style="margin: 1% 1% 1% 1%;  width: 31%; float: left;">Get Server Info</button>
            <button onclick="systemTask('restart_bot')" class="btn btn-warning" style="margin: 1% 1% 1% 1%;  width: 31%; float: left;">Restart bot</button>
            <button onclick="systemTask('getTempfileCount')" class="btn btn-primary" style="margin: 1% 1% 1% 1%;  width: 31%; float: left;">Get Temp File</button>
            
            <button onclick="systemTask('clearTempFile')" class="btn btn-secondary" style="margin: 1% 1% 1% 1%;  width: 31%; float: left;">Clear Temp File</button>
            <button onclick="systemTask('mysqlStatus')" class="btn btn-success" style="margin: 1% 1% 1% 1%;  width: 31%; float: left;">Check Mysql Status</button>
            <button onclick="systemTask('restart_mysql')" class="btn btn-danger" style="margin: 1% 1% 1% 1%;  width: 31%; float: left;">Restart Mysql</button>
          </div>
          <div id="systemResponse" class="form-control" style=" display: none; margin-top: 10px; background-color: #222; color: #aaa; padding: 20px; max-height: 300px; min-height: 120px; overflow: auto;">
            <h4 style="text-align: center">Response From Server</h4>
            <pre id="systemOutput" style="color: #cccfd0"></pre>
          </div>

          <hr>
          <input id='date' class="form-control" style=" float: left; width: 40%; margin-right: 10px; height: 40px; margin-bottom: 10px" type="date" value="12/12/2019" name="Selectdate">

          <button id="sortByToggleButton" type="button" class="btn btn-outline-info">Sort by tracks</button>
            
          <div id="message" class="alert-light" style="text-align: center; ">
            <hr>Please select date to show bot result
          </div>

          <hr>

          <div id="botList" style="display: block; margin-top: 18px; overflow: auto; max-height: 425px;">
            <table id="botListTable" class="table table-hover">
              <thead style="display: none">
                <tr>
                  <th>Bot</th>
                  <th>Play Track</th>
                  <th>Play Count</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>

          <div id="musicList" style="display: none">
              <div style="display: none; margin-top: 18px; height: 430px">
                  <div
                    style="height: 428px; border: 1px solid #4cadc3; border-radius: 4px; width: 30%; float: left;">
                    <span style="text-align: center; display: block; padding: 5px 2px; color: #3dabbf; background-image: linear-gradient(#acd2d4, #fffff7);">Track List</span>
                    <UL id="musicListDiv" style="padding-left: 0px; margin-bottom: 0px; overflow: auto; max-height: calc(100% - 34px);">
                    </UL>
                  </div>
                  <div
                    style="height: 428px; border: 1px solid #4cadc3; border-radius: 4px; width: 30%; float: left; margin-left: 1%; margin-right: 1%;">
                    <span style="text-align: center; display: block; padding: 5px 2px; color: #3dabbf; background-image: linear-gradient(#acd2d4, #fffff7);">Bot List</span>
                    <UL id="botListDiv" style="padding-left: 0px; margin-bottom: 0px; overflow: auto; max-height: calc(100% - 34px);">
                    </UL>
                  </div>
                  <div
                    style="height: 428px; border: 1px solid #4cadc3; border-radius: 4px; width: 38%; float: right;">
                    <span style="text-align: center; display: block; padding: 5px 2px; color: #3dabbf; background-image: linear-gradient(#acd2d4, #fffff7);">Play Status</span>
                      <div style="padding-left: 0px; margin-bottom: 0px; overflow: auto; max-height: calc(100% - 34px);">
                          <table id="playListDiv" class="table table-hover">
                              <thead>
                                <tr>
                                  <th>Start Play</th>
                                  <th>End Track</th>
                                  <th>Status</th>
                                </tr>
                              </thead>
                              <tbody>
                              </tbody>
                            </table>
                      </div>
                  </div>
              </div>
          </div>

        </div>

      </div>
      <div id="nextPrevBtn" style="
          padding: 5px 0px;
          flex: 1;
          flex-direction: row;
          align-items: flex-end;
          float: right;
          display: none;">
        <input style="width: 120px; background-color: #ecddb1f0; border: 1px solid #e0a638; margin: 0px 10px 0px 10px;"
          class="btn" type="button" id="prvBtn" value="Prev">
        <span id="pageNo" style="
                border: 1px solid #222;
                padding: 6px 8px;
                border-radius: 4px;
                margin-right: 1px;
                background-color: #fff;
                border-color: #d6ae3e;
                "> </span>
        <input style="width: 120px; background-color: #ecddb1f0; border: 1px solid #e0a638; margin: 0px 10px 0px 10px;"
          class="btn" type="button" id="nxtBtn" value="Next">
      </div>
    </div>
  </div>

  <footer>
    <% include ../partials/footer %>
  </footer>

  <script>
    var response = {};

    systemTask = (data) => {
      $('#systemOutput').html('')
      $.ajax({
        url: '/admin/servertask',
        type: "POST",
        data: { command: data },
        success: function (response) {
          console.log('res : ', response);

          // $('#systemResponse').html(response)
          $('#systemOutput').html(response)
          
        },
        error: function (error) {
          console.error(error);
        }
      });
    }

    getBotStatus = () => {
      $.ajax({
        url: '/admin/botstatus',
        type: "POST",
        success: function (response) {
          $('#botstatus').show();
          if (response.type == 'success') {
            $('#botstatus').removeClass('alert-success alert-danger alert-warning').addClass('alert-success');
            $($('#botstatus').children()[0]).html('Bot status: All bots are running ');
          }
          if (response.type == 'error') {
            $('#botstatus').removeClass('alert-success alert-danger alert-warning').addClass('alert-danger');
            $($('#botstatus').children()[0]).html('Bot status: Some Error occured. Bot stop running ');
          }
          if (response.type == 'warning') {
            $('#botstatus').removeClass('alert-success alert-danger alert-warning').addClass('alert-warning');
            $($('#botstatus').children()[0]).html('Bot status: Bots are idle ');
          }
          $('#botstatusDetails').html(response.details);
        },
        error: function (error) {
          console.error(error);
        }
      });
    }

    setInterval(() => {getBotStatus();}, 1000)
  
    getData = (date = '') => {
      if ($('#date').val() == '') return;
      $.ajax({
        url: '/admin/botdashboard',
        type: "POST",
        data: { date: $('#date').val() },
        success: function (response) {
          $('#botListTable').find('tbody').html('');
          if (response.length < 1) {
            $('#botListTable').find('thead').hide();
            $('#message').show();
            $('#message').html('<hr>No result found for this date');
          } else {
            $('#message').hide();
            $('#botListTable').find('thead').show();
            showAllBotList(response);
          }
        },
        error: function (error) {
          console.error(error);
        }
      });
    }

    getMusicByDate = (date = '') => {
      if ($('#date').val() == '') return;
      $.ajax({
        url: '/admin/getmusic',
        type: "POST",
        data: { date: $('#date').val() },
        success: function (response) {
          $('#musicListDiv').html('');
          if (response.length < 1) {
            $('#musicList').children().hide();
            $('#message').show();
            $('#message').html('<hr>No result found for this date');
          } else {
            $('#message').hide();
            $('#musicList').children().show();
            $('#musicList').parent().show();
            $('#botListDiv').parent().hide();
            $('#playListDiv').parent().parent().hide();
            showMusicList(response);
          }
        },
        error: function (error) {
          console.error(error);
        }
      });
    }

    getBotByMusicId = (date = '', track_id = '') => {
      if ($('#date').val() == '' || track_id == '') return;
      $.ajax({
        url: '/admin/getbot',
        type: "POST",
        data: { date: $('#date').val(), track_id: track_id},
        success: function (response) {
          $('#botListDiv').html('');
          if (response.length < 1) {
            $('#musicList').children().hide();
            $('#message').show();
            $('#message').html('<hr>No result found for this date');
          } else {
            $('#message').hide();
            $('#musicList').children().show();
            $('#musicList').parent().show();
            $('#botListDiv').parent().show();
            $('#playListDiv').parent().parent().hide();
            showBotList(response);
          }
        },
        error: function (error) {
          console.error(error);
        }
      });
    }

    getPlayDetailsByBotId = (date = '', track_id = '', bot_id = '') => {
      if ($('#date').val() == '' || track_id == '' || bot_id == '') return;
      $.ajax({
        url: '/admin/getplaydetails',
        type: "POST",
        data: {
          date: $('#date').val(),
          track_id: track_id,
          bot_id: bot_id,
        },
        success: function (response) {
          $('#playListDiv').find('tbody').html('');
          if (response.length < 1) {
            $('#musicList').children().hide();
            $('#message').show();
            $('#message').html('<hr>No result found for this date');
          } else {
            $('#message').hide();
            $('#musicList').children().show();
            $('#musicList').parent().show();
            $('#botListDiv').parent().show();
            $('#playListDiv').parent().parent().show();
            showPlayList(response);
          }
        },
        error: function (error) {
          console.error(error);
        }
      });
    }

    showMusicList = (response) => {
      response.map((item, i) => {
        $('#musicListDiv').append(`
        <LI class="list-group-item list-group-item-action" onclick="getBotList('${item.track_id}', this)">
          ${item.track_name}
        <span class="badge badge-primary badge-pill" style="float: right; float: right; width: 30px; padding: 6px; border-radius: 4px;">${item.play_count}</span>
        </LI>
      `);
      });
    }

    showPlayList = (response) => {
      response.map((item, i) => {
        // console.log(' item.created_at : ',  item.created_at);
        // console.log(' item.updated_at : ',  item.updated_at);
        var str = item.created_at;
        var res = str.split("T")
        var startTime = res[1].slice(0, 8);

        var str = item.updated_at;
        var res = str.split("T")
        var endTime = item.created_at != '' && item.created_at == item.updated_at ?  '  -- : -- ' : res[1].slice(0, 8);
      
        var status = item.created_at != '' && item.created_at == item.updated_at ? 'Running' : 'Done';

        console.log(' item.created_at : ',  startTime);
        console.log(' item.updated_at : ',  endTime);

        $('#playListDiv').find('tbody').append(`
          <tr>
            <td>${startTime}</td>
            <td>${endTime}</td>
            <td>
                <span class="badge ${status == 'Running' ? 'badge-info' : 'badge-primary'}" style="padding: 6px 6px;">${status}</span>  
            </td>
          </tr>
        `);
      });
    }

    showBotList = (response) => {
      response.map((item, i) => {
        $('#botListDiv').append(`
        <LI class="list-group-item list-group-item-action" onclick="getPlayList('${item.track_id}', '${item.played_by_bot_id}', this)">
          ${item.played_by_bot_id}
        <span class="badge badge-primary badge-pill" style="float: right; float: right; width: 30px; padding: 6px; border-radius: 4px;">${item.play_count}</span>
        </LI>
      `);
      });
    }

    showAllBotList = (response) => {
      let temp = '';
      response.map((item, i) => {
        prev = i > 0 ? response[i - 1].played_by_bot_id : '';
        $('#botListTable').find('tbody').append(`
          <tr>
            <td>${item.played_by_bot_id == prev ? '' : item.played_by_bot_id}</td>
            <td>${item.track_name}</td>
            <td>${item.playCount}</td>
            <td>Done</td>
          </tr>
      `);
      });
    }

    getBotList = (track_id, selector) => {
      $(selector).css('background-color', '#d6e4e8')
      $(selector).siblings().css('background-color', '');

      const date = $('#date').val();
      getBotByMusicId(date, track_id);
    }

    getPlayList = (track_id, bot_id, selector) => {
      $(selector).css('background-color', '#d6e4e8')
      $(selector).siblings().css('background-color', '');
      const date = $('#date').val();
      getPlayDetailsByBotId(date, track_id, bot_id);
    }

    $(document).ready(function () {
      $('#onClickAddNewTrack').on('click', () => window.location.replace(`/admin`));

      $('#date').on('change', () => {
        const date = $('#date').val();
        getData(date);
        getMusicByDate(date);
      });
      
      $('#date').change().val(new Date().toISOString().slice(0, 10));
      getData(date);
      getMusicByDate(date);
      
      $('#sortByToggleButton').on('click', () => {
        const date = $('#date').val();
        if (date == null) return;
        if ($('#sortByToggleButton').html() == 'Sort by tracks') {
          $('#sortByToggleButton').html('Sort by bots');
          getData(date);
        } else {
          $('#sortByToggleButton').html('Sort by tracks');
          getMusicByDate(date);
        }
          $('#botList').toggle();
          $('#musicList').toggle();
      });
    });


  </script>

</body>

</html>