<!-- views/admin/pages/tracklist.ejs -->

<!DOCTYPE html>
<html lang="en">

<head>
  <% include ../partials/head %>
  <!-- <script>var track_id = window.location.search.split("=")[1];</script> -->

</head>

<body>
  <header>
    <% include ../partials/header %>
  </header>

  <div id='search-track' class="container">
    <div class="row">
      <div class="offset-md-1 col-md-10 login-form-1">
        <h3>Bot Dashboard</h3>
        <p id="errorMsg" style="
        float: left;
        font-size: 21px;
        margin: 5px 5px 5px 5px;
        color: #b30a0ab0;
        padding: 1px 10px;"></p>
        <button id="onClickAddNewTrack" class="btn btn-info" style="
          float: right;
          font-size: 13px;
          margin: 5px 5px 5px 5px;">
          <i class="fa fa-arrow-circle-left"></i> &nbsp Dashboard
          <!-- <i class="fa fa-arrow-left"></i> &nbsp Dashboard -->

        </button>
        <div id="list-music-track" class="form-control" style="min-height: 45px;"></div>
        <div id="track-details" class="form-control" style="min-height: 230px; max-height: 600px">
          <div class="alert alert-lite" role="alert" style="text-align: center; caption-side: top;">Bot Status </div>

          <!-- <div class="alert alert-success" role="alert" style="text-align: center; caption-side: top;">Bot status: All bots are running</div> -->
          <div class="alert alert-danger" role="alert" style="text-align: center; caption-side: top; display: none">Bot status: Some Error occured. <a href="#" class="alert-link">Click here</a> </div>
          <hr>
          <input id='date' class="form-control" style=" float: left; width: 40%; margin-right: 10px; height: 40px; margin-bottom: 10px" type="date" value="12/12/2019" name="Selectdate">
            
          <button id="sortByToggleButton" type="button" class="btn btn-outline-info">Sort by tracks</button>
            
          <div id="message" class="alert-light" style="text-align: center; caption-side: top;">
            <hr>Please select date to show bot result
          </div>

          <hr>

          <div id="botList" style="display: block; margin-top: 18px; overflow: auto; max-height: 425px;">
            <table id="botListTable" class="table table-hover">
              <thead style="display: none">
                <tr>
                  <th>Bot</th>
                  <th>Play Track</th>
                  <th>Play Count</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>

          <div id="musicList" style="display: none">
              <div style="display: none; margin-top: 18px; height: 430px">
                  <div
                    style="height: 428px; border: 1px solid #4cadc3; border-radius: 4px; width: 30%; float: left;">
                    <span style="text-align: center; display: block; padding: 5px 2px; color: #3dabbf; background-image: linear-gradient(#acd2d4, #fffff7);">Track List</span>
                    <UL id="musicListDiv" style="padding-left: 0px; margin-bottom: 0px; overflow: auto; max-height: calc(100% - 34px);">
                    </UL>
                  </div>
                  <div
                    style="height: 428px; border: 1px solid #4cadc3; border-radius: 4px; width: 30%; float: left; margin-left: 1%; margin-right: 1%;">
                    <span style="text-align: center; display: block; padding: 5px 2px; color: #3dabbf; background-image: linear-gradient(#acd2d4, #fffff7);">Bot List</span>
                    <UL id="botListDiv" style="padding-left: 0px; margin-bottom: 0px; overflow: auto; max-height: calc(100% - 34px);">
                    </UL>
                  </div>
                  <div
                    style="height: 428px; border: 1px solid #4cadc3; border-radius: 4px; width: 38%; float: right;">
                    <span style="text-align: center; display: block; padding: 5px 2px; color: #3dabbf; background-image: linear-gradient(#acd2d4, #fffff7);">Play Status</span>
                      <div style="padding-left: 0px; margin-bottom: 0px; overflow: auto; max-height: calc(100% - 34px);">
                          <table id="playListDiv" class="table table-hover">
                              <thead>
                                <tr>
                                  <th>Start Play</th>
                                  <!-- <th>End Track</th> -->
                                  <th>Status</th>
                                </tr>
                              </thead>
                              <tbody>
                              </tbody>
                            </table>
                      </div>
                  </div>
              </div>
          </div>

        </div>

      </div>
      <div id="nextPrevBtn" style="
          padding: 5px 0px;
          flex: 1;
          flex-direction: row;
          align-items: flex-end;
          float: right;
          display: none;">
        <input style="width: 120px; background-color: #ecddb1f0; border: 1px solid #e0a638; margin: 0px 10px 0px 10px;"
          class="btn" type="button" id="prvBtn" value="Prev">
        <span id="pageNo" style="
                border: 1px solid #222;
                padding: 6px 8px;
                border-radius: 4px;
                margin-right: 1px;
                background-color: #fff;
                border-color: #d6ae3e;
                "> </span>
        <input style="width: 120px; background-color: #ecddb1f0; border: 1px solid #e0a638; margin: 0px 10px 0px 10px;"
          class="btn" type="button" id="nxtBtn" value="Next">
      </div>
    </div>
  </div>

  <footer>
    <% include ../partials/footer %>
  </footer>

  <script>
    var response = {};

    // var musicList = [];
    // var botList = [];

    getData = (date = '') => {
      if ($('#date').val() == '') return;
      $.ajax({
        url: '/admin/botdashboard',
        type: "POST",
        data: { date: $('#date').val() },
        success: function (response) {
          $('#botListTable').find('tbody').html('');
          if (response.length < 1) {
            $('#botListTable').find('thead').hide();
            $('#message').show();
            $('#message').html('<hr>No result found for this date');
          } else {
            $('#message').hide();
            $('#botListTable').find('thead').show();
            showAllBotList(response);
          }
        },
        error: function (error) {
          console.error(error);
        }
      });
    }

    getMusicByDate = (date = '') => {
      if ($('#date').val() == '') return;
      $.ajax({
        url: '/admin/getmusic',
        type: "POST",
        data: { date: $('#date').val() },
        success: function (response) {
          // console.log(response);
          $('#musicListDiv').html('');
          if (response.length < 1) {
            $('#musicList').children().hide();
            $('#message').show();
            $('#message').html('<hr>No result found for this date');
          } else {
            $('#message').hide();
            $('#musicList').children().show();
            $('#musicList').parent().show();
            $('#botListDiv').parent().hide();
            $('#playListDiv').parent().parent().hide();
            showMusicList(response);
          }
        },
        error: function (error) {
          console.error(error);
        }
      });
    }

    getBotByMusicId = (date = '', track_id = '') => {
      if ($('#date').val() == '' || track_id == '') return;
      $.ajax({
        url: '/admin/getbot',
        type: "POST",
        data: { date: $('#date').val(), track_id: track_id},
        success: function (response) {
          $('#botListDiv').html('');
          if (response.length < 1) {
            $('#musicList').children().hide();
            $('#message').show();
            $('#message').html('<hr>No result found for this date');
          } else {
            $('#message').hide();
            $('#musicList').children().show();
            $('#musicList').parent().show();
            $('#botListDiv').parent().show();
            $('#playListDiv').parent().parent().hide();
            showBotList(response);
          }
        },
        error: function (error) {
          console.error(error);
        }
      });
    }

    getPlayDetailsByBotId = (date = '', track_id = '', bot_id = '') => {
      if ($('#date').val() == '' || track_id == '' || bot_id == '') return;
      $.ajax({
        url: '/admin/getplaydetails',
        type: "POST",
        data: {
          date: $('#date').val(),
          track_id: track_id,
          bot_id: bot_id,
        },
        success: function (response) {
          $('#playListDiv').find('tbody').html('');
          if (response.length < 1) {
            $('#musicList').children().hide();
            $('#message').show();
            $('#message').html('<hr>No result found for this date');
          } else {
            $('#message').hide();
            $('#musicList').children().show();
            $('#musicList').parent().show();
            $('#botListDiv').parent().show();
            $('#playListDiv').parent().parent().show();
            showPlayList(response);
          }
        },
        error: function (error) {
          console.error(error);
        }
      });
    }

    showMusicList = (response) => {
      response.map((item, i) => {
        $('#musicListDiv').append(`
        <LI class="list-group-item list-group-item-action" onclick="getBotList('${item.track_id}', this)">
          ${item.track_name}
        <span class="badge badge-primary badge-pill" style="float: right; float: right; width: 30px; padding: 6px; border-radius: 4px;">${item.play_count}</span>
        </LI>
      `);
      });
    }

    showPlayList = (response) => {
      response.map((item, i) => {
        var str = item.created_at;
        var res = str.split("T")
        var startTime = res[1].slice(0, 8);

        var str = item.updated_at;
        var res = str.split("T")
        var endTime = res[1].slice(0, 8);

        // status = Done, Running, Error
        var status = !item.updated_at || item.updated_at == '' ? 'Running' : 'Done';

        $('#playListDiv').find('tbody').append(`
          <tr>
            <td>${startTime}</td>
            <td>
                <span class="badge badge-primary" style="padding: 6px 6px;">${status}</span>  
            </td>
          </tr>
        `);
      });
    }

    showBotList = (response) => {
      response.map((item, i) => {
        $('#botListDiv').append(`
        <LI class="list-group-item list-group-item-action" onclick="getPlayList('${item.track_id}', '${item.played_by_bot_id}', this)">
          ${item.played_by_bot_id}
        <span class="badge badge-primary badge-pill" style="float: right; float: right; width: 30px; padding: 6px; border-radius: 4px;">${item.play_count}</span>
        </LI>
      `);
      });
    }

    showAllBotList = (response) => {
      let temp = '';
      response.map((item, i) => {
        prev = i > 0 ? response[i - 1].played_by_bot_id : '';
        $('#botListTable').find('tbody').append(`
          <tr>
            <td>${item.played_by_bot_id == prev ? '' : item.played_by_bot_id}</td>
            <td>${item.track_name}</td>
            <td>${item.playCount}</td>
            <td>Done</td>
          </tr>
      `);
      });
    }

    getBotList = (track_id, selector) => {
      $(selector).css('background-color', '#d6e4e8')
      $(selector).siblings().css('background-color', '');

      const date = $('#date').val();
      getBotByMusicId(date, track_id);
    }

    getPlayList = (track_id, bot_id, selector) => {
      $(selector).css('background-color', '#d6e4e8')
      $(selector).siblings().css('background-color', '');
      const date = $('#date').val();
      getPlayDetailsByBotId(date, track_id, bot_id);
    }

    $(document).ready(function () {
      $('#onClickAddNewTrack').on('click', () => window.location.replace(`/admin`));

      $('#date').on('change', () => {
        const date = $('#date').val();
        // if ($('#sortByToggleButton').html() == 'Sort by tracks') {
        getData(date);
        // } else {
        getMusicByDate(date);
        // }
      });

      // $("select.selectBot").change(function(){
      //     var selectedBot = $(this).children("option:selected").val();
      //     console.log('selectedBot :', selectedBot);
      // });



      $('#sortByToggleButton').on('click', () => {
        const date = $('#date').val();
        if ($('#sortByToggleButton').html() == 'Sort by tracks') {
          $('#sortByToggleButton').html('Sort by bots');
          getData(date);
        } else {
          $('#sortByToggleButton').html('Sort by tracks');
          getMusicByDate(date);
        }
        if (date != '') {
          $('#botList').toggle();
          $('#musicList').toggle();
        }

      });
      // $('#botListDiv').parent().show()
    });

    // $('#musicListDiv').children()[0]

  </script>

</body>

</html>